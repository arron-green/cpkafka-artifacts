#!/usr/bin/env bash
set -ex
source ${SDKMAN_DIR}/bin/sdkman-init.sh &> /dev/null
PKG_NAME=kafka
cd "${HOME}" && (curl -s -L https://github.com/confluentinc/${PKG_NAME}/archive/${PKG_KAFKA_VER}.tar.gz | tar -zx)

test -z "$GITHUB_CLIENT_ID" -o -z "$GITHUB_CLIENT_SECRET" || GITHUB_API_PARAMS="?client_id=$GITHUB_CLIENT_ID&client_secret=$GITHUB_CLIENT_SECRET"
BRANCH_META=$(curl -s "https://api.github.com/repos/confluentinc/${PKG_NAME}/branches/${PKG_KAFKA_VER}${GITHUB_API_PARAMS}" | jq -r -c '.commit')
COMMIT_SHA=$(echo ${BRANCH_META} | jq -r -c '.sha')
COMMIT_DATE=$(echo ${BRANCH_META} | jq -r -c '.commit.committer.date')

cd "${HOME}/${PKG_NAME}-${PKG_KAFKA_VER}"
gradle installAll releaseTarGz -x signArchives

tar -czf ${HOME}/pkg-${PKG_NAME}-${COMMIT_SHA}.tgz *
